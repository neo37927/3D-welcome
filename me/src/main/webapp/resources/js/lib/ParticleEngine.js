var ParticleEngine=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p=!1;a=a||{},_size=a.size||512,h=a.simMat||createShaderMaterial(BasicSimShader),i=a.initMat||createShaderMaterial(SimInitShader),j=a.drawMat||createShaderMaterial(BasicParticleShader),o=a.update;var q=function(){d.setSize(window.innerWidth,window.innerHeight)},r=function(a,b){w(),x(),l.enabled||l.update(),o&&o(a,b),d.update(a),n.render()},s=function(a,b){p||g.update(a,b)},t=function(){window.addEventListener("resize",q,!1),c=new UpdateLoop,c.frameCallback=r,c.fixedCallback=s,b=document.querySelector("#webgl-canvas"),k=new Mouse(b),d=new RenderContext(b),d.init(),e=d.getCamera(),f=d.getScene()},u=function(){g=new ParticleSimulation(d.getRenderer(),_size,{simMat:h,initMat:i,drawMat:j}),f.add(g.getParticleObject()),e.position.set(0,0,8),l=new THREE.OrbitControls(e,b),l.rotateUp(Math.PI/6),l.autoRotate=!0,l.autoRotateSpeed=1,l.noPan=!0,l.enabled=!1,m=new THREE.Raycaster;var a=(new THREE.Matrix4).compose(new THREE.Vector3(0,-3,-e.position.z),new THREE.Quaternion,new THREE.Vector3(.015,.015,.015));n=new LeapManager(d.getRenderer(),e,a),h.defines.MULTIPLE_INPUT="",h.needsUpdate=!0,_debugBox=document.querySelector("#debug-box")},v=function(){for(var a=Utils.isMobile?4:1,b=0;a>b;b++){var c=k.getMouse(b);if(c.buttons[0]||0===b&&c.buttons[2]){m.setFromCamera(c.coords,e);var d=l.target,f=d.clone().sub(e.position).normalize(),g=new THREE.Plane(f,-f.x*d.x-f.y*d.y-f.z*d.z),i=m.ray.intersectPlane(g);h.uniforms.uInputPos.value[b].copy(i),h.uniforms.uInputPosAccel.value.setComponent(b,c.buttons[0]?1:-1)}else h.uniforms.uInputPosAccel.value.setComponent(b,0)}},w=function(){var a=1,b=100;n.update();for(var c=0;c<n.activeHandCount;c++){var d=3-c;n.frame.hands[c].grabStrength===a?(h.uniforms.uInputPos.value[d].copy(n.palmPositions[c]),h.uniforms.uInputPosAccel.value.setComponent(d,1)):n.frame.hands[c].sphereRadius>=b&&(h.uniforms.uInputPos.value[d].copy(n.palmPositions[c]),h.uniforms.uInputPosAccel.value.setComponent(d,-1))}},x=function(){h.uniforms.uInputPosAccel.value.set(0,0,0,0),l.enabled||v(),w()};this.start=function(){c.start()},this.stop=function(){c.stop()},this.pauseSimulation=function(a){p=a},this.enableCameraAutoRotate=function(a){l.autoRotate=a},this.enableCameraControl=function(a){l.enabled=a},t(),u(),this.renderer=d,this.scene=f,this.camera=e};